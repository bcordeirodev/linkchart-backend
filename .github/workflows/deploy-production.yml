name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.LINK_CHART_ACTION_KEY }}

    - name: Add server to known hosts
      run: |
        ssh-keyscan -H 138.197.121.81 >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        ssh root@138.197.121.81 << 'ENDSSH'
          cd /var/www/linkchartapi

          # Backup do ambiente atual
          echo "ğŸ“¦ Criando backup do ambiente atual..."
          cp .env .env.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo "Nenhum .env anterior encontrado"

          # Pull latest changes
          echo "â¬‡ï¸ Baixando alteraÃ§Ãµes do repositÃ³rio..."
          git fetch origin
          git reset --hard origin/main

          # Copy production environment
          echo "ğŸ“‹ Copiando configuraÃ§Ãµes de produÃ§Ã£o..."
          cp .env.production .env

          # Debug: Verificar se JWT_SECRET foi copiado corretamente
          echo "ğŸ” Verificando JWT_SECRET..."
          if grep -q "JWT_SECRET=SPF" .env; then
            echo "âœ… JWT_SECRET correto encontrado no .env"
          else
            echo "âš ï¸ JWT_SECRET nÃ£o encontrado ou incorreto, aplicando correÃ§Ã£o..."
            sed -i 's/JWT_SECRET=.*/JWT_SECRET=SPFbPErKrHyA5rc0Lwswwbs2EXVlwkC1DckzF6wb8CwpUxf4yLYjMtiJOVhRtWnW1A2B3C4D5E6F7G8H9I0J1K2L3M4N5O6P7Q8R9S0T/' .env
            echo "âœ… JWT_SECRET corrigido"
          fi

          # Verificar outras configuraÃ§Ãµes crÃ­ticas
          echo "ğŸ”§ Verificando configuraÃ§Ãµes crÃ­ticas..."
          grep "APP_ENV=production" .env && echo "âœ… APP_ENV correto" || echo "âš ï¸ APP_ENV pode estar incorreto"
          grep "APP_DEBUG=false" .env && echo "âœ… APP_DEBUG correto" || echo "âš ï¸ APP_DEBUG pode estar incorreto"

          # Garantir permissÃµes corretas
          chmod 644 .env
          echo "âœ… PermissÃµes do .env configuradas"

          # Parar containers e limpar caches antigos
          echo "ğŸ›‘ Parando containers e limpando caches..."
          docker-compose -f docker-compose.prod.yml down || true
          docker exec linkchartapi php /var/www/artisan config:clear 2>/dev/null || true
          docker exec linkchartapi php /var/www/artisan cache:clear 2>/dev/null || true

          # Build and restart containers
          echo "ğŸ—ï¸ Rebuilding containers..."
          docker-compose -f docker-compose.prod.yml build --no-cache

          echo "ğŸš€ Iniciando containers..."
          docker-compose -f docker-compose.prod.yml up -d

          # Wait for containers to be ready
          echo "â³ Aguardando containers ficarem prontos..."
          sleep 20

          # Verificar se containers estÃ£o rodando
          echo "ğŸ” Verificando status dos containers..."
          docker ps --filter "name=linkchartapi" --filter "status=running" | grep linkchartapi && echo "âœ… App container rodando" || echo "âŒ App container com problema"
          docker ps --filter "name=linkchartdb" --filter "status=running" | grep linkchartdb && echo "âœ… Database container rodando" || echo "âŒ Database container com problema"
          docker ps --filter "name=linkchartredis" --filter "status=running" | grep linkchartredis && echo "âœ… Redis container rodando" || echo "âŒ Redis container com problema"

          # Run Laravel optimizations
          echo "âš¡ Executando otimizaÃ§Ãµes do Laravel..."
          docker exec linkchartapi php /var/www/artisan config:cache
          docker exec linkchartapi php /var/www/artisan route:cache
          docker exec linkchartapi php /var/www/artisan view:cache

          # Verificar se JWT estÃ¡ funcionando corretamente
          echo "ğŸ§ª Testando configuraÃ§Ã£o JWT..."
          JWT_CONFIG=$(docker exec linkchartapi php /var/www/artisan tinker --execute="echo config('jwt.secret');" 2>/dev/null | tail -1)
          if [[ "$JWT_CONFIG" == *"SPF"* ]]; then
            echo "âœ… JWT_SECRET carregado corretamente no Laravel"
          else
            echo "âŒ JWT_SECRET nÃ£o carregado corretamente: $JWT_CONFIG"
            echo "ğŸ”§ Tentando corrigir cache do Laravel..."
            docker exec linkchartapi php /var/www/artisan config:clear
            docker exec linkchartapi php /var/www/artisan config:cache
          fi

          # Testar conexÃ£o com banco e Redis
          echo "ğŸ”— Testando conexÃµes..."
          docker exec linkchartapi php /var/www/artisan tinker --execute="DB::connection()->getPdo(); echo 'Database OK';" || echo "âŒ Problema na conexÃ£o com banco"
          docker exec linkchartapi php /var/www/artisan tinker --execute="Cache::store('redis')->put('test', 'ok'); echo 'Redis OK';" || echo "âŒ Problema na conexÃ£o com Redis"

          # Health check
          echo "ğŸ¥ Executando health check..."
          sleep 5
          if curl -f http://localhost/health; then
            echo "âœ… Deployment successful!"
            echo "ğŸ‰ AplicaÃ§Ã£o estÃ¡ funcionando corretamente"
          else
            echo "âŒ Deployment failed - executando rollback"
            docker-compose -f docker-compose.prod.yml down

            # Tentar restaurar backup
            BACKUP_FILE=$(ls -t .env.backup.* 2>/dev/null | head -1)
            if [ -n "$BACKUP_FILE" ]; then
              echo "ğŸ“¦ Restaurando backup: $BACKUP_FILE"
              cp "$BACKUP_FILE" .env
            else
              echo "ğŸ“‹ Usando .env.production como fallback"
              cp .env.production .env
            fi

            docker-compose -f docker-compose.prod.yml up -d
            exit 1
          fi
        ENDSSH

    - name: Verify deployment
      run: |
        sleep 10
        echo "ğŸ” VerificaÃ§Ã£o final de produÃ§Ã£o..."
        if curl -f http://138.197.121.81/health; then
          echo "âœ… Production deployment verified!"

          # Teste adicional da API
          response=$(curl -s -o /dev/null -w "%{http_code}" http://138.197.121.81/api/links)
          if [ "$response" == "401" ]; then
            echo "âœ… API respondendo corretamente (401 - autenticaÃ§Ã£o necessÃ¡ria)"
          else
            echo "âš ï¸ API resposta inesperada: $response"
          fi
        else
          echo "âŒ Production verification failed!"
          exit 1
        fi

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸš€ Production deployment completed successfully!"
          echo "ğŸ“Š Status dos serviÃ§os:"
          echo "  âœ… AplicaÃ§Ã£o Laravel"
          echo "  âœ… PostgreSQL Database"
          echo "  âœ… Redis Cache"
          echo "  âœ… Nginx Proxy"
          echo "  âœ… JWT Authentication"
        else
          echo "ğŸ’¥ Production deployment failed!"
          echo "ğŸ” Verifique os logs acima para identificar o problema"
        fi
