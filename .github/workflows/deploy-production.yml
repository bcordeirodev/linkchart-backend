name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.LINK_CHART_ACTION_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        echo "StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no root@138.197.121.81 << 'ENDSSH'
          cd /var/www/linkchartapi

          # Limpar backups antigos (manter apenas os 3 mais recentes)
          echo "ğŸ§¹ Limpando backups antigos..."
          ls -t .env.backup.* 2>/dev/null | tail -n +4 | xargs rm -f 2>/dev/null || true

          # Pull latest changes
          echo "â¬‡ï¸ Baixando alteraÃ§Ãµes do repositÃ³rio..."
          git fetch origin
          git reset --hard origin/main

          # Backup current .env if exists
          if [ -f .env ]; then
            echo "ğŸ’¾ Criando backup do .env atual..."
            cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
          fi

          # Copy production environment
          echo "ğŸ“‹ Copiando configuraÃ§Ãµes de produÃ§Ã£o..."
          cp .env.production .env

          # Configurar JWT_SECRET do GitHub Secrets
          echo "ğŸ” Configurando JWT_SECRET do GitHub Secrets..."
          sed -i "s/JWT_SECRET=.*/JWT_SECRET=${{ secrets.JWT_SECRET }}/" .env

          # DB e Redis jÃ¡ estÃ£o configurados corretamente no .env.production
          echo "âœ… DB_PASSWORD e REDIS_PASSWORD jÃ¡ configurados no .env.production"

          # Debug: Verificar se JWT_SECRET foi configurado corretamente
          echo "ğŸ” Verificando JWT_SECRET..."
          if grep -q "JWT_SECRET=" .env && [ "$(grep 'JWT_SECRET=' .env | cut -d'=' -f2 | wc -c)" -gt 10 ]; then
            echo "âœ… JWT_SECRET configurado corretamente"
          else
            echo "âŒ JWT_SECRET nÃ£o configurado ou muito curto"
            exit 1
          fi

          # Verificar outras configuraÃ§Ãµes crÃ­ticas
          echo "ğŸ”§ Verificando configuraÃ§Ãµes crÃ­ticas..."
          grep "APP_ENV=production" .env && echo "âœ… APP_ENV correto" || echo "âš ï¸ APP_ENV pode estar incorreto"
          grep "APP_DEBUG=false" .env && echo "âœ… APP_DEBUG correto" || echo "âš ï¸ APP_DEBUG pode estar incorreto"
          grep "DB_PASSWORD=" .env && echo "âœ… DB_PASSWORD configurado" || echo "âŒ DB_PASSWORD nÃ£o encontrado"
          grep "REDIS_PASSWORD=" .env && echo "âœ… REDIS_PASSWORD configurado" || echo "âŒ REDIS_PASSWORD nÃ£o encontrado"

          # Garantir permissÃµes corretas
          chmod 644 .env
          echo "âœ… PermissÃµes do .env configuradas"

          # Parar containers
          echo "ğŸ›‘ Parando containers..."
          docker compose -f docker-compose.prod.yml down || true

          # Build and restart containers
          echo "ğŸ—ï¸ Rebuilding containers..."
          docker compose -f docker-compose.prod.yml build

          echo "ğŸš€ Iniciando containers..."
          docker compose -f docker-compose.prod.yml up -d

          # Wait for containers to be ready
          echo "â³ Aguardando containers ficarem prontos..."
          sleep 20

          # Verificar se containers estÃ£o rodando
          echo "ğŸ” Verificando status dos containers..."
          docker ps --filter "name=linkchartapi" --filter "status=running" | grep linkchartapi && echo "âœ… App container rodando" || echo "âŒ App container com problema"
          docker ps --filter "name=linkchartdb" --filter "status=running" | grep linkchartdb && echo "âœ… Database container rodando" || echo "âŒ Database container com problema"
          docker ps --filter "name=linkchartredis" --filter "status=running" | grep linkchartredis && echo "âœ… Redis container rodando" || echo "âŒ Redis container com problema"

          # Run Laravel API optimizations (sem view:cache)
          echo "âš¡ Executando otimizaÃ§Ãµes da API Laravel..."
          docker exec linkchartapi php /var/www/artisan config:clear
          docker exec linkchartapi php /var/www/artisan cache:clear
          docker exec linkchartapi php /var/www/artisan config:cache
          docker exec linkchartapi php /var/www/artisan route:cache

          # Verificar se JWT estÃ¡ funcionando corretamente
          echo "ğŸ§ª Testando configuraÃ§Ã£o JWT..."
          JWT_CONFIG=$(docker exec linkchartapi php /var/www/artisan tinker --execute="echo strlen(config('jwt.secret'));" 2>/dev/null | tail -1)
          if [ "$JWT_CONFIG" -gt 10 ]; then
            echo "âœ… JWT_SECRET carregado corretamente no Laravel (length: $JWT_CONFIG)"
          else
            echo "âŒ JWT_SECRET nÃ£o carregado corretamente ou muito curto: $JWT_CONFIG"
            echo "ğŸ”§ Tentando corrigir cache do Laravel..."
            docker exec linkchartapi php /var/www/artisan config:clear
            docker exec linkchartapi php /var/www/artisan config:cache
          fi

          # Testar conexÃ£o com banco e Redis
          echo "ğŸ”— Testando conexÃµes..."
          docker exec linkchartapi php /var/www/artisan tinker --execute="DB::connection()->getPdo(); echo 'Database OK';" || echo "âŒ Problema na conexÃ£o com banco"
          docker exec linkchartapi php /var/www/artisan tinker --execute="Cache::store('redis')->put('test', 'ok'); echo 'Redis OK';" || echo "âŒ Problema na conexÃ£o com Redis"

          # Configurar diretÃ³rios essenciais primeiro
          echo "ğŸ”§ Configurando diretÃ³rios essenciais..."
          docker exec linkchartapi /var/www/setup-production-dirs.sh

          # Limpar todos os caches apÃ³s mudanÃ§as
          echo "ğŸ§¹ Limpando todos os caches..."
          docker exec linkchartapi php /var/www/artisan optimize:clear
          docker exec linkchartapi php /var/www/artisan config:cache

          # Health check
          echo "ğŸ¥ Executando health check..."
          sleep 5
          if curl -f http://138.197.121.81/health; then
            echo "âœ… Deployment successful!"
            echo "ğŸ‰ AplicaÃ§Ã£o estÃ¡ funcionando corretamente"
          else
            echo "âŒ Deployment failed - executando rollback"
            docker compose -f docker-compose.prod.yml down

            # Tentar restaurar backup
            BACKUP_FILE=$(ls -t .env.backup.* 2>/dev/null | head -1)
            if [ -n "$BACKUP_FILE" ]; then
              echo "ğŸ“¦ Restaurando backup: $BACKUP_FILE"
              cp "$BACKUP_FILE" .env
            else
              echo "ğŸ“‹ Usando .env.production como fallback"
              cp .env.production .env
            fi

            docker compose -f docker-compose.prod.yml up -d
            exit 1
          fi
        ENDSSH

    - name: Verify deployment
      run: |
        sleep 10
        echo "ğŸ” VerificaÃ§Ã£o final de produÃ§Ã£o..."
        if curl -f http://138.197.121.81/health; then
          echo "âœ… Production deployment verified!"

          # Teste adicional da API
          response=$(curl -s -o /dev/null -w "%{http_code}" http://138.197.121.81/api/links)
          if [ "$response" == "401" ]; then
            echo "âœ… API respondendo corretamente (401 - autenticaÃ§Ã£o necessÃ¡ria)"
          else
            echo "âš ï¸ API resposta inesperada: $response"
          fi
        else
          echo "âŒ Production verification failed!"
          exit 1
        fi

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸš€ Production deployment completed successfully!"
          echo "ğŸ“Š Status dos serviÃ§os:"
          echo "  âœ… AplicaÃ§Ã£o Laravel"
          echo "  âœ… PostgreSQL Database"
          echo "  âœ… Redis Cache"
          echo "  âœ… Nginx Proxy"
          echo "  âœ… JWT Authentication"
        else
          echo "ğŸ’¥ Production deployment failed!"
          echo "ğŸ” Verifique os logs acima para identificar o problema"
        fi
